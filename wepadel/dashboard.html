<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard ‚Äì Caf√©Misu √ó We Padel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Export libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: 'Playfair Display', serif;
        background: #F2EBE4;
        margin: 0;
        padding: 20px;
        color: #3E2A21;
    }

    h1 {
        text-align: center;
        margin-bottom: 25px;
        font-size: 2.2rem;
        font-weight: 700;
        color: #3E2A21;
    }

    .filter-bar {
        display:flex;
        flex-wrap:wrap;
        gap:10px;
        justify-content:center;
        margin-bottom:20px;
    }

    .filter-btn {
        padding:12px 20px;
        border:none;
        border-radius:10px;
        cursor:pointer;
        font-size:16px;
        background:#E8DAD2;
        color:#3E2A21;
        font-weight:600;
        transition:0.2s;
    }

    .filter-btn:hover {
        background:#D8C5BA;
    }

    .active {
        background:#3E2A21 !important;
        color:white !important;
    }

    .order-card {
        position:relative;
        background:white;
        padding:22px;
        margin-bottom:22px;
        border-radius:14px;
        box-shadow:0 6px 14px rgba(0,0,0,0.12);
        border-left:10px solid #A87555;
        transition:0.2s;
    }

    .order-card:hover {
        transform:scale(1.01);
    }

    .delete-btn {
        position:absolute;
        top:12px;
        right:12px;
        background:#c0392b;
        color:white;
        border:none;
        border-radius:50%;
        width:26px;
        height:26px;
        font-size:15px;
        cursor:pointer;
        font-weight:bold;
    }

    .badge {
        display:inline-block;
        padding:8px 16px;
        border-radius:20px;
        font-size:14px;
        font-weight:600;
        color:white;
        margin-bottom:15px;
    }

    .badge-new { background:#A87555; }
    .badge-served { background:#3B82F6; }
    .badge-paid { background:#EAB308; color:black; }
    .badge-done { background:#22C55E; }

    ul {
        padding-left:20px;
        margin-top:10px;
        margin-bottom:20px;
    }

    li {
        font-size:1.05rem;
        margin-bottom:6px;
    }

    .btn-actions {
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        margin-top:10px;
    }

    .action-btn {
        padding:12px 18px;
        border:none;
        border-radius:10px;
        cursor:pointer;
        font-size:15px;
        font-weight:600;
        color:white;
        flex:1;
        min-width:110px;
        text-align:center;
    }

    .btn-new { background:#A87555; }
    .btn-served { background:#3B82F6; }
    .btn-paid { background:#EAB308; color:black; }
    .btn-done { background:#22C55E; }

</style>
</head>

<body>

<h1>üìã Commandes ‚Äì Caf√©Misu √ó We Padel</h1>

<div class="filter-bar">
    <button class="filter-btn active" onclick="setFilter('active')">Actives</button>
    <button class="filter-btn" onclick="setFilter('done')">Termin√©es</button>
    <button class="filter-btn" onclick="setFilter('all')">Toutes</button>
</div>

<div class="filter-bar">
    <input type="date" id="dateFilter" onchange="loadOrders()" class="filter-btn" style="padding:10px 15px;">
</div>

<div class="filter-bar">
    <button class="filter-btn" onclick="toggleSort()">üìÖ Tri date (asc/desc)</button>
</div>

<div class="filter-bar">
    <button class="filter-btn" onclick="exportXLS()">üìÑ Export XLS</button>
    <button class="filter-btn" onclick="exportPDF()">üñ®Ô∏è Export PDF</button>
</div>

<div id="orders"></div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDb7QDl0VF5vhQahUaua5z2EzYQovdt9Y",
    authDomain: "cafemisu-wepadel.firebaseapp.com",
    projectId: "cafemisu-wepadel",
    storageBucket: "cafemisu-wepadel.appspot.com",
    messagingSenderId: "158465399626",
    appId: "1:158465399626:web:382a8671ca9b32b3aba4273"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentFilter = "active";
let sortDirection = "desc";

function setFilter(f) {
    currentFilter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    loadOrders();
}

function loadOrders() {
    db.collection("orders")
      .orderBy("timestamp", sortDirection)
      .onSnapshot(snap => {
        let html = "";
        const all = [];

        const selectedDate = document.getElementById("dateFilter").value;

        snap.forEach(doc => {
            const o = doc.data();
            o.id = doc.id;

            if (currentFilter === "active" && o.status === "done") return;
            if (currentFilter === "done" && o.status !== "done") return;

            if (selectedDate) {
                const orderDate = o.time?.split(" ")[0];
                const [d,m,y] = orderDate.split("/");
                if (`${y}-${m}-${d}` !== selectedDate) return;
            }

            all.push(o);
            html += generateCard(o);
        });

        window._exportData = all;
        document.getElementById("orders").innerHTML = html;
      });
}

function generateCard(o) {

    const total = o.items.reduce((sum, i) => sum + i.price, 0);

    const badge =
        o.status === "new"    ? `<span class="badge badge-new">üü´ NEW</span>` :
        o.status === "served" ? `<span class="badge badge-served">üü¶ SERVED</span>` :
        o.status === "paid"   ? `<span class="badge badge-paid">üü® PAID</span>` :
                                `<span class="badge badge-done">üü© DONE</span>`;

    return `
    <div class="order-card">

        <button class="delete-btn" onclick="deleteOrder('${o.id}')">√ó</button>

        <h2>ü™ë Table ${o.table}</h2>
        ${badge}

        <ul>
            ${o.items.map(i => `<li>${i.name} ‚Äî ${i.price} FCFA</li>`).join("")}
        </ul>

        <p><b>Total :</b> ${total.toLocaleString()} FCFA</p>
        <p><b>Client :</b> ${o.customer}</p>
        <p><b>Heure :</b> ${o.time}</p>

        <div class="btn-actions">
            <button class="action-btn btn-new" onclick="updateStatus('${o.id}','new')">New</button>
            <button class="action-btn btn-served" onclick="updateStatus('${o.id}','served')">Served</button>
            <button class="action-btn btn-paid" onclick="updateStatus('${o.id}','paid')">Paid</button>
            <button class="action-btn btn-done" onclick="updateStatus('${o.id}','done')">Terminer</button>
        </div>
    </div>`;
}

function updateStatus(id, status) {
    db.collection("orders").doc(id).update({ status });
}

function deleteOrder(id) {
    if (!confirm("Supprimer d√©finitivement cette commande ?")) return;
    db.collection("orders").doc(id).delete();
}

function exportXLS() {
    const ws = XLSX.utils.json_to_sheet(window._exportData || []);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Commandes");
    XLSX.writeFile(wb, "commandes.xlsx");
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 10;

    (window._exportData || []).forEach(o => {
        const total = o.items.reduce((s, i) => s + i.price, 0);

        pdf.text(`Table ${o.table} | ${o.time} | ${o.status} | Total: ${total} FCFA`, 10, y); 
        y += 8;

        o.items.forEach(i => { 
            pdf.text(`- ${i.name} : ${i.price} FCFA`, 14, y); 
            y += 6; 
        });

        y += 8;
    });

    pdf.save("commandes.pdf");
}

function toggleSort() {
    sortDirection = sortDirection === "desc" ? "asc" : "desc";
    loadOrders();
}

loadOrders();
</script>

</body>
</html>
