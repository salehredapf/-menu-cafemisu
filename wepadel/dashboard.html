<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard â€“ CafÃ©Misu Ã— We Padel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<!-- Export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: 'Playfair Display', serif;
        background: #F7EFEA;
        margin: 0;
        padding: 20px;
        color: #5D3A2C;
    }
    h1 { text-align:center; }

    .filter-bar { display:flex; gap:10px; justify-content:center; margin-bottom:20px; }
    .filter-btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; }
    .active { background:#5D3A2C; color:white; }

    #export-bar {
        display:flex;
        justify-content:center;
        gap:10px;
        margin-bottom:20px;
    }
    .order-card {
        background:white; padding:18px; margin-bottom:20px;
        border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }
    .order-footer { display:flex; justify-content:flex-end; margin-top:10px; }
    .btn-end { padding:10px 16px; border:none; background:#7C3AED; color:white; border-radius:8px; cursor:pointer; }
</style>
</head>

<body>

<h1>ðŸ“‹ Commandes â€“ CafÃ©Misu Ã— We Padel</h1>

<!-- FILTRES -->
<div class="filter-bar">
    <button class="filter-btn active" onclick="setFilter('active')">Commandes actives</button>
    <button class="filter-btn" onclick="setFilter('done')">Commandes terminÃ©es</button>
    <button class="filter-btn" onclick="setFilter('all')">Toutes</button>
</div>

<!-- EXPORT -->
<div id="export-bar">
    <button class="filter-btn" onclick="exportXLS()">Exporter XLS</button>
    <button class="filter-btn" onclick="exportPDF()">Exporter PDF</button>
</div>

<div id="orders"></div>

<script>
/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
    apiKey: "AIzaSyDb7QDl0VF5vhQahUaua5z2EzYQovdt9Y",
    authDomain: "cafemisu-wepadel.firebaseapp.com",
    projectId: "cafemisu-wepadel",
    storageBucket: "cafemisu-wepadel.appspot.com",
    messagingSenderId: "158465399626",
    appId: "1:158465399626:web:382a8671ca9b32b3aba4273"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* -------------- LOGIQUE FILTRE -------------- */
let currentFilter = "active";

function setFilter(f) {
    currentFilter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    loadOrders();
}

/* -------------- CHARGEMENT COMMANDES -------------- */
function loadOrders() {
    db.collection("orders")
      .orderBy("timestamp", "desc")
      .onSnapshot(snap => {
        let html = "";
        const allOrders = [];

        snap.forEach(doc => {
            const d = doc.data();
            d.id = doc.id;

            allOrders.push(d);

            if (currentFilter === "active" && d.status === "done") return;
            if (currentFilter === "done" && d.status !== "done") return;

            html += generateCard(d);
        });

        window._exportData = allOrders; // pour XLS/PDF
        document.getElementById("orders").innerHTML = html;
      });
}

/* -------------- GENERATION CARTE COMMANDE -------------- */
function generateCard(d) {
    return `
    <div class="order-card">
        <h2>Table ${d.table}</h2>

        <p><b>Status :</b> ${d.status}</p>

        <ul>
            ${d.items.map(i => `<li>${i.name} â€” ${i.price} FCFA</li>`).join("")}
        </ul>

        <p><b>Client :</b> ${d.customer}</p>
        <p><b>Heure :</b> ${d.time}</p>

        <div class="order-footer">
            <button class="btn-end" onclick="finishOrder('${d.id}')">Terminer</button>
        </div>
    </div>`;
}

/* -------------- ACTION FINIR ---------------- */
function finishOrder(id) {
    db.collection("orders").doc(id).update({ status: "done" });
}

/* -------------- EXPORT XLS -------------- */
function exportXLS() {
    const rows = window._exportData || [];
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Commandes");
    XLSX.writeFile(wb, "commandes.xlsx");
}

/* -------------- EXPORT PDF -------------- */
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 10;

    (window._exportData || []).forEach(o => {
        pdf.text(`Table ${o.table} | ${o.time} | ${o.status}`, 10, y); y += 8;
        o.items.forEach(i => { pdf.text(`- ${i.name} : ${i.price} FCFA`, 14, y); y += 6; });
        y += 8;
    });

    pdf.save("commandes.pdf");
}

/* INIT */
loadOrders();
</script>

</body>
</html>
